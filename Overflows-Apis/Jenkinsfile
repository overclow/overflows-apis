// Jenkins Pipeline for overflows-apis
// Python FastAPI Backend

pipeline {
    agent any
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    environment {
        PROJECT_NAME = 'overflows-apis'
        API_PORT = '8000'
        API_HOST = '127.0.0.1'
        PYTHON_VERSION = '3.12'
        NODE_ENV = 'production'
        BUILD_TIMESTAMP = sh(script: "date -u +'%Y-%m-%dT%H:%M:%SZ'", returnStdout: true).trim()
    }
    
    stages {
        stage('ğŸ“‹ Checkout') {
            steps {
                script {
                    echo "ğŸ”„ Checking out code from GitHub..."
                }
                checkout scm
                sh 'git log --oneline -1'
            }
        }
        
        stage('ğŸ” Environment Check') {
            steps {
                script {
                    echo "ğŸ” Verifying Python environment..."
                }
                sh '''
                    python3 --version
                    pip3 --version
                '''
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“¦ Installing Python dependencies..."
                }
                sh '''
                    # Create virtual environment if it doesn't exist
                    if [ ! -d venv ]; then
                        python3 -m venv venv
                    fi
                    
                    # Activate and upgrade pip
                    . venv/bin/activate
                    pip install --upgrade pip setuptools wheel
                    
                    # Install requirements
                    if [ -f requirements.txt ]; then
                        pip install -r requirements.txt
                    else
                        echo "âš ï¸ No requirements.txt found"
                    fi
                '''
            }
        }
        
        stage('ğŸ” Lint & Type Check') {
            steps {
                script {
                    echo "ğŸ” Running code quality checks..."
                }
                sh '''
                    . venv/bin/activate
                    
                    # Check Python syntax
                    python3 -m py_compile api/*.py 2>&1 || echo "âš ï¸ Syntax warnings found"
                    
                    # Try to import main module
                    python3 -c "import sys; sys.path.insert(0, '.'); import animation_api" 2>&1 || echo "âš ï¸ Import check failed"
                '''
            }
        }
        
        stage('ğŸ§ª Quick Validation') {
            steps {
                script {
                    echo "ğŸ§ª Running quick validation..."
                }
                sh '''
                    . venv/bin/activate
                    
                    # Check FastAPI imports
                    python3 << 'EOF'
import sys
try:
    from fastapi import FastAPI
    from fastapi.middleware.cors import CORSMiddleware
    import uvicorn
    print("âœ… All required FastAPI modules available")
except ImportError as e:
    print(f"âš ï¸ Missing module: {e}")
    sys.exit(1)
EOF
                '''
            }
        }
        
        stage('ğŸš€ Deploy API Server') {
            steps {
                script {
                    echo "ğŸš€ Deploying API server..."
                }
                sh '''
                    echo "ğŸ“ Checking if API is already running..."
                    lsof -ti:${API_PORT} | xargs kill -9 2>/dev/null || echo "âœ“ No existing API found"
                    
                    sleep 2
                    
                    echo "ğŸ”„ Starting overflows-apis server..."
                    . venv/bin/activate
                    
                    # Start API with nohup and disown
                    nohup python3 -m uvicorn api.workflow_api:app --host ${API_HOST} --port ${API_PORT} --reload > /tmp/overflows-api.log 2>&1 &
                    API_PID=$!
                    echo "$API_PID" > /tmp/api.pid
                    disown $API_PID 2>/dev/null || true
                    
                    sleep 4
                    
                    # Verify API is responding
                    echo "ğŸ” Verifying API connectivity..."
                    MAX_RETRIES=5
                    RETRY=0
                    while [ $RETRY -lt $MAX_RETRIES ]; do
                        if curl -s http://${API_HOST}:${API_PORT}/docs > /dev/null 2>&1; then
                            echo "âœ… API is responding (PID: $API_PID)"
                            break
                        else
                            RETRY=$((RETRY + 1))
                            if [ $RETRY -lt $MAX_RETRIES ]; then
                                echo "â³ Waiting for API... ($RETRY/$MAX_RETRIES)"
                                sleep 2
                            fi
                        fi
                    done
                    
                    if [ $RETRY -eq $MAX_RETRIES ]; then
                        echo "âŒ API connectivity check failed"
                        echo "Error log:"
                        tail -20 /tmp/overflows-api.log
                        exit 1
                    fi
                '''
            }
        }
        
        stage('ğŸ“Š Verify API Endpoints') {
            steps {
                script {
                    echo "ğŸ“Š Verifying API endpoints..."
                }
                sh '''
                    echo "ğŸ” Checking API health endpoints..."
                    
                    # Check docs endpoint
                    if curl -s http://${API_HOST}:${API_PORT}/docs | grep -q "fastapi"; then
                        echo "âœ… Swagger UI available at: http://${API_HOST}:${API_PORT}/docs"
                    else
                        echo "âš ï¸ Swagger UI check failed"
                    fi
                    
                    # Check ReDoc endpoint
                    if curl -s http://${API_HOST}:${API_PORT}/redoc | grep -q "redoc"; then
                        echo "âœ… ReDoc available at: http://${API_HOST}:${API_PORT}/redoc"
                    else
                        echo "âš ï¸ ReDoc check failed"
                    fi
                '''
            }
        }
        
        stage('ğŸ“ˆ Generate Report') {
            steps {
                script {
                    echo "ğŸ“ˆ Generating build report..."
                }
                sh '''
                    cat > build-report.txt << 'REPORT'
=== Build Summary ===
Project: overflows-apis
Build Number: ${BUILD_NUMBER}
Build Time: ${BUILD_TIMESTAMP}
Git Branch: $(git rev-parse --abbrev-ref HEAD)
Git Commit: $(git rev-parse --short HEAD)
Commit Author: $(git log -1 --format=%an)
Commit Message: $(git log -1 --format=%s)

=== API Server Info ===
API Host: ${API_HOST}
API Port: ${API_PORT}
Swagger UI: http://${API_HOST}:${API_PORT}/docs
ReDoc: http://${API_HOST}:${API_PORT}/redoc
OpenAPI JSON: http://${API_HOST}:${API_PORT}/openapi.json

=== Environment ===
Python: $(python3 --version)
FastAPI Version: $(pip3 show fastapi | grep Version | cut -d' ' -f2)

REPORT
                    cat build-report.txt
                '''
            }
        }
        
        stage('âœ… Build Complete') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "âœ… Build completed successfully!"
                    echo ""
                    echo "ğŸš€ API Server (launchd managed):"
                    echo "   URL: http://${API_HOST}:${API_PORT}"
                    echo "   Swagger UI: http://${API_HOST}:${API_PORT}/docs"
                    echo "   ReDoc: http://${API_HOST}:${API_PORT}/redoc"
                    echo ""
                    echo "ğŸ“Š Build Info:"
                    echo "   Job: overflows-apis"
                    echo "   Build: #${BUILD_NUMBER}"
                    echo "   Timestamp: ${BUILD_TIMESTAMP}"
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "âœ… Pipeline succeeded!"
                echo ""
                echo "ğŸš€ API is live and serving requests!"
                echo ""
                echo "ğŸ“Š API Status:"
                sh '''
                    if curl -s http://${API_HOST}:${API_PORT}/docs > /dev/null 2>&1; then
                        echo "  âœ… API is responding"
                    else
                        echo "  âš ï¸ API may be starting, give it a moment"
                    fi
                '''
                echo ""
                echo "ğŸŒ Access API:"
                echo "   Documentation: http://${API_HOST}:${API_PORT}/docs"
                echo "   Alternative: http://${API_HOST}:${API_PORT}/redoc"
            }
        }
        
        failure {
            script {
                echo "âŒ Pipeline failed!"
                echo "ğŸ” Check logs above for details"
            }
        }
        
        cleanup {
            script {
                echo "ğŸ§¹ Cleaning up temporary files..."
                sh '''
                    rm -f build-report.txt 2>/dev/null || true
                    
                    # API is managed by launchd, so we don't kill it
                    echo "âœ… API (launchd managed) will serve requests"
                '''
            }
        }
    }
}
